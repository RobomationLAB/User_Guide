name: Generate PDF from Wiki

on:
  schedule:
    - cron: '0 15 * * *' # (UTC 기준 15시 -> 한국 기준 0시) 마다 MD -> PDF 변환
  workflow_dispatch:
  repository_dispatch:
    types: [wiki-updated]

env:
  REPO_OWNER: RobomationLAB # github username 작성
  REPO_NAME: User_Guide # main repository name 작성
  WIKI_REPO_NAME: User_Guide.wiki # wiki repository name 작성
  COMMITTER_NAME: github-actions[bot] 
  COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
  BRANCH: main
  GH_TOKEN: ${{ secrets.GH_PAT }}

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.GH_TOKEN }}

      - name: Clone Wiki repository
        run: |
          git clone https://${{ env.GH_TOKEN }}@github.com/${{ env.REPO_OWNER }}/${{ env.WIKI_REPO_NAME }}.git wiki
          cd wiki
          git config user.name "${{ env.COMMITTER_NAME }}"
          git config user.email "${{ env.COMMITTER_EMAIL }}"

      - name: Cache LaTeX packages
        uses: actions/cache@v3
        with:
          path: |
            /usr/share/texlive
            /usr/share/texmf
          key: ${{ runner.os }}-texlive-${{ hashFiles('**/*.md') }}
          restore-keys: |
            ${{ runner.os }}-texlive-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-lang-cjk \
            texlive-latex-extra \
            texlive-lang-chinese \
            lmodern \
            fonts-noto-cjk \
            librsvg2-bin

      - name: Install wkhtmltopdf 0.12.6.1-3 (patched)
        run: |
          sudo apt-get update
      
          sudo apt-get install -y \
            fontconfig \
            libxrender1 \
            xfonts-75dpi \
            xfonts-base \
            libjpeg-turbo8
          wget -O /tmp/wkhtmltox_0.12.6.1-3.jammy_amd64.deb \
            https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6.1-3/wkhtmltox_0.12.6.1-3.jammy_amd64.deb
          sudo apt-get install -y /tmp/wkhtmltox_0.12.6.1-3.jammy_amd64.deb

      - name: Create custom font LaTeX header
        run: |
          cd wiki
          cat > font-custom.tex << 'EOF'
          % Package for any font size
          \usepackage{anyfontsize}

          % Code highlighting and verbatim - 5pt font
          \usepackage{fancyvrb}
          \usepackage{fvextra}

          % Define Highlighting environment for pandoc code blocks - 5pt
          \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
            % fontsize=\fontsize{5pt}{6pt}\selectfont,
            breaklines=true,
            breaksymbolleft={},
            showspaces=false,
            showtabs=false,
            commandchars=\\\{\}
          }

          % Override verbatim environment - 5pt
          % \fvset{fontsize=\fontsize{5pt}{6pt}\selectfont}

          % Inline code - 5pt font
          \let\oldtexttt\texttt
          % \renewcommand{\texttt}[1]{{\fontsize{5pt}{6pt}\selectfont\oldtexttt{#1}}}
          EOF

      - name: Generate PDFs
        run: |
          cd wiki

          # 구성-요소-및-사용-방법.pdf에 포함될 Wiki 파일명(확장자 제외)
          USAGE_PAGES=("상단-메뉴" "에디터" "미리보기")

          ## 파일 묶기
          echo "# 구성 요소 및 사용 방법" > merged.md
          echo "" >> merged.md
          for page in "${USAGE_PAGES[@]}"; do
            file="${page}.md"
            if [ -f "$file" ]; then
              echo "# $page" >> merged.md
              echo "" >> merged.md
              cat "$file" >> merged.md
              echo "" >> merged.md
              echo "---" >> merged.md
              echo "" >> merged.md
            fi
          done

          ## raw 링크를 로컬 assets 경로로 변환 (PDF 변환만을 위해)
          python3 - <<'PY'
          import re, os, unicodedata
          from urllib.parse import urlsplit, unquote
      
          SRC = "merged.md"
          OUT = "구성-요소-및-사용-방법.md"
      
          asset_map = {}
          for root, _, files in os.walk("assets"):
            for f in files:
              p = os.path.join(root, f).replace("\\", "/")
              for norm in ("NFC", "NFD"):
                asset_map[unicodedata.normalize(norm, p)] = p
      
          RAW_PREFIX = "https://raw.githubusercontent.com/RobomationLAB/User_Guide/"
      
          def url_to_local(url: str) -> str:
            # raw URL이면 /assets/ 이후를 로컬 경로로
            if url.startswith(RAW_PREFIX):
              u = urlsplit(url)
              path = u.path
              idx = path.find("/assets/")
              if idx != -1:
                local = path[idx+1:]          # assets/...
                local = unquote(local)        # %.. 디코딩 (URL에 들어있는 유니코드 그대로)
                # NFC/NFD 둘 다 시도해서 실제 파일 경로로 교정
                for norm in ("NFC", "NFD"):
                  cand = unicodedata.normalize(norm, local)
                  if cand in asset_map:
                    return asset_map[cand]
                return local
            return url

          def width_to_attr(width: str) -> str:
            # width="50%" -> { width=50% }
            w = width.strip().strip('"').strip("'")
            m = re.fullmatch(r"(\d+(?:\.\d+)?)\s*%", w)
            if m:
              return f'{{ width={m.group(1)}% }}'
            # px 등은 일단 무시(필요하면 변환 가능)
            return ""
      
          s = open(SRC, "r", encoding="utf-8").read()
      
          # <img src="..." width="..."> 를 ![](...){ width=... } 로 변환
          img_pat = re.compile(
            r'<img\b([^>]*?)\bsrc="([^"]+)"([^>]*?)>',
            re.IGNORECASE
          )
      
          def repl_img(m):
            before, src, after = m.group(1), m.group(2), m.group(3)
            local = url_to_local(src)
      
            # width 추출
            width_m = re.search(r'\bwidth="([^"]+)"', before + " " + after, re.IGNORECASE)
            attr = width_to_attr(width_m.group(1)) if width_m else ""
      
            # alt는 없으면 빈 값
            alt_m = re.search(r'\balt="([^"]+)"', before + " " + after, re.IGNORECASE)
            alt = alt_m.group(1) if alt_m else ""
      
            return f'![{alt}]({local}){(" " + attr) if attr else ""}'
      
          s = img_pat.sub(repl_img, s)
      
          # <br>는 줄바꿈으로 (선택)
          s = re.sub(r"<br\s*/?>", "\n", s, flags=re.IGNORECASE)
      
          open(OUT, "w", encoding="utf-8").write(s)
      
          # 디버그: 변환 후 이미지가 몇 개인지 출력
          imgs = re.findall(r'!\[[^\]]*\]\([^)]+\)', s)
          print("converted images:", len(imgs))
          PY

          # PDF 생성
          pandoc 구성-요소-및-사용-방법.md \
            --from markdown+raw_html \
            --pdf-engine=xelatex \
            -V mainfont="Noto Sans CJK KR" \
            -V sansfont="Noto Sans CJK KR" \
            -V monofont="Noto Sans Mono CJK KR" \
            -V CJKmainfont="Noto Sans CJK KR" \
            -V CJKsansfont="Noto Sans CJK KR" \
            -V CJKmonofont="Noto Sans Mono CJK KR" \
            -H font-custom.tex \
            -V geometry:margin=1.5cm \
            -V linestretch=1.5 \
            -V fontsize=11pt \
            --highlight-style=tango \
            -o 구성-요소-및-사용-방법.pdf

          rm -f merged.md merged.html wkhtml.log
          

          # 기본-블록.pdf에 포함될 Wiki 파일명(확장자 제외)
          BLOCK_PAGES=("논리" "조건문" "반복" "연산" "문자열" "리스트" "색상" "소리" "제어" "변수" "함수" "기타")

          # 파일 묶기
          echo "# 기본 블록" > 기본-블록.md
          echo "" >> 기본-블록.md
          for page in "${BLOCK_PAGES[@]}"; do
            file="${page}.md"
            if [ -f "$file" ]; then
              echo "# $page" >> 기본-블록.md
              echo "" >> 기본-블록.md
              cat "$file" >> 기본-블록.md
              echo "" >> 기본-블록.md
              echo "---" >> 기본-블록.md
              echo "" >> 기본-블록.md
            fi
          done

          # PDF 생성
          pandoc 기본-블록.md \
            --pdf-engine=xelatex \
            -V mainfont="Noto Sans CJK KR" \
            -V sansfont="Noto Sans CJK KR" \
            -V monofont="Noto Sans Mono CJK KR" \
            -V CJKmainfont="Noto Sans CJK KR" \
            -V CJKsansfont="Noto Sans CJK KR" \
            -V CJKmonofont="Noto Sans Mono CJK KR" \
            -H font-custom.tex \
            -V geometry:margin=1.5cm \
            -V linestretch=1.5 \
            -V fontsize=11pt \
            --highlight-style=tango \
            -o 기본-블록.pdf


          # 나머지 Wiki 파일 개별 PDF 생성
          for file in *.md; do
            base=$(basename "$file" .md)

            # 기본 블록 페이지거나, Home 이면 건너뜀
            if [[ " ${USAGE_PAGES[*]} " =~ " ${base} " || " ${BLOCK_PAGES[*]} " =~ " ${base} " || "$base" = "Home" || "$base" = "_Sidebar" ]]; then
              continue
            fi

            # PDF 생성
            pandoc "$file" \
              --pdf-engine=xelatex \
              -V mainfont="Noto Sans CJK KR" \
              -V sansfont="Noto Sans CJK KR" \
              -V monofont="Noto Sans Mono CJK KR" \
              -V CJKmainfont="Noto Sans CJK KR" \
              -V CJKsansfont="Noto Sans CJK KR" \
              -V CJKmonofont="Noto Sans Mono CJK KR" \
              -H font-custom.tex \
              -V geometry:margin=1.5cm \
              -V linestretch=1.5 \
              -V fontsize=11pt \
              --highlight-style=tango \
              -o "${base}.pdf" 
          done

      - name: Commit PDF to repository
        run: |
          cd ${{ github.workspace }}
        
          mkdir -p PDF
          mv wiki/*.pdf PDF/
          rm -rf wiki/
        
          git config user.name "${COMMITTER_NAME}"
          git config user.email "${COMMITTER_EMAIL}"
          git remote set-url origin https://x-access-token:${{ env.GH_TOKEN }}@github.com/${REPO_OWNER}/${REPO_NAME}.git
          git fetch origin
          git reset --hard origin/$BRANCH
          git add PDF/*.pdf
          
          if ! git diff --staged --quiet; then
            git commit -m "Update Wiki to PDFs"
            git push origin $BRANCH
          fi
